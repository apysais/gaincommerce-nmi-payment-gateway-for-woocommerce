(()=>{"use strict";const e=window.wp.element,a=window.wp.i18n,t=wc.wcBlocksRegistry,o=wc.wcSettings,n=window.wp.components;console.log("AP NMI Blocks: Script loading...");const r=(0,o.getSetting)("gaincommerce_nmi_data",{}),c=(0,a.__)("Gain Commerce NMI Payment Gateway for WooCommerce","gaincommerce-nmi-payment-gateway-for-woocommerce");console.log("AP NMI Blocks: Settings loaded",r);const l=({billing:t,eventRegistration:o,emitResponse:c})=>{const{onPaymentSetup:l}=o,[s,m]=(0,e.useState)({ccnumber:!1,ccexp:!1,cvv:!0}),[i,d]=(0,e.useState)(null),[p,y]=(0,e.useState)(!1),[u,g]=(0,e.useState)(!1),_=(0,e.useRef)(!1),f=(0,e.useRef)(!1),v=(0,e.useRef)(null);return(0,e.useEffect)(()=>{_.current=p},[p]),(0,e.useEffect)(()=>{f.current=u},[u]),(0,e.useEffect)(()=>{if("undefined"==typeof CollectJS)return console.error("AP NMI Blocks: CollectJS not loaded"),void d((0,a.__)("Payment form failed to load. Please refresh the page.","gaincommerce-nmi-payment-gateway-for-woocommerce"));console.log("AP NMI Blocks: Initializing CollectJS..."),CollectJS.configure({variant:"inline",invalidCss:{color:"#e74c3c","border-color":"#e74c3c"},validCss:{color:"black","border-color":"#2ecc71"},placeholderCss:{color:"darkgray","background-color":"#ffffff"},focusCss:{color:"black","border-color":"#4681f4"},fields:{ccnumber:{selector:"#ap-nmi-card-number",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ap-nmi-expiry-date",title:"Card Expiration",placeholder:"MM/YY"},cvv:{display:"show",selector:"#ap-nmi-card-cvv",title:"CVV",placeholder:"123"}},validationCallback:(e,a,t)=>{console.log("AP NMI Blocks: Validation:",e,a,t),m(t=>({...t,[e.field||e]:a}))},callback:e=>{if(console.log("AP NMI Blocks: CollectJS callback triggered.",e),v.current){if(v.current.clearTimeout&&v.current.clearTimeout(),e.card&&e.card.type&&r.restricted_card_types.includes(e.card.type)){const e=(0,a.__)("This card type is not accepted.","gaincommerce-nmi-payment-gateway-for-woocommerce");return d(e),v.current.reject({type:c.responseTypes.ERROR,message:e}),void(v.current=null)}if(e.token)console.log("AP NMI Blocks: Token generated successfully:",e.token),console.log("AP NMI Blocks: savePaymentMethod state:",_.current),console.log("AP NMI Blocks: save_payment_method value being sent:",_.current?"1":"0"),v.current.resolve({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e.token,save_payment_method:_.current?"1":"0",use_save_payment_method:"0"}}}),console.log("AP NMI Blocks: paymentMethodData sent:",{payment_token:e.token,save_payment_method:_.current?"1":"0",use_save_payment_method:"0"});else{console.error("AP NMI Blocks: Token generation failed.",e);const t=e.error?.message||(0,a.__)("Invalid card details. Please check and try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");d(t),v.current.reject({type:c.responseTypes.ERROR,message:t})}v.current=null}}})},[]),(0,e.useEffect)(()=>l(()=>{if(console.log("AP NMI Blocks: onPaymentSetup triggered."),d(null),f.current&&r.has_saved_card)return console.log("AP NMI Blocks: Using saved payment method."),{type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0"}}};if(!Object.values(s).every(Boolean)){console.log("AP NMI Blocks: Validation failed before tokenization.",s);const e=(0,a.__)("Please fill in all required payment fields.","gaincommerce-nmi-payment-gateway-for-woocommerce");return d(e),{type:c.responseTypes.ERROR,message:e}}return console.log("AP NMI Blocks: All fields appear valid, requesting token..."),new Promise((e,t)=>{v.current={resolve:e,reject:t,clearTimeout:null};const o=setTimeout(()=>{console.error("AP NMI Blocks: Tokenization timed out.");const e=(0,a.__)("Payment processing timed out. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");d(e),v.current&&(v.current.reject({type:c.responseTypes.ERROR,message:e}),v.current=null)},15e3);v.current.clearTimeout=()=>clearTimeout(o),CollectJS.startPaymentRequest()})}),[l,s,u]),(0,e.createElement)("div",{className:"ap-nmi-payment-form-blocks"},i&&(0,e.createElement)("div",{className:"woocommerce-error",role:"alert"},i),r.has_saved_card&&r.saved_card_details&&(0,e.createElement)("div",{className:"ap-nmi-saved-card-selection",style:{marginBottom:"1em"}},(0,e.createElement)("label",{style:{display:"block",marginBottom:"0.5em"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"1",checked:u,onChange:()=>g(!0),style:{marginRight:"0.5em"}}),(0,a.__)("Use saved card ending in","gaincommerce-nmi-payment-gateway-for-woocommerce")," ****",r.saved_card_details.last4,r.saved_card_details.type&&` (${r.saved_card_details.type})`,r.saved_card_details.exp_date&&` - Exp: ${r.saved_card_details.exp_date}`),(0,e.createElement)("label",{style:{display:"block"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"0",checked:!u,onChange:()=>g(!1),style:{marginRight:"0.5em"}}),(0,a.__)("Use a new card","gaincommerce-nmi-payment-gateway-for-woocommerce"))),(0,e.createElement)("div",{style:{display:r.has_saved_card&&u?"none":"block"}},(0,e.createElement)("div",{className:"ap-nni-card-icons-container"},(0,e.createElement)("div",{className:"ap-nmi-card-icons"},r.allowed_card_types&&Object.entries(r.allowed_card_types).map(([a,t])=>(0,e.createElement)("span",{key:a,className:`card-icon ${a} ${t.status}`,title:t.title}))),r.restricted_card_types.length>0&&(0,e.createElement)("div",{className:"ap-nmi-card-restrictions-info"},(0,a.__)("Cards marked with âœ• are not accepted for payment.","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("p",null)),(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-number"},(0,a.__)("Card Number","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-card-number"})),(0,e.createElement)("div",{className:"ap-nmi-row"},(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-first"},(0,e.createElement)("label",{htmlFor:"ap-nmi-expiry-date"},(0,a.__)("Expiry Date","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-expiry-date"})),(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-last"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-cvv"},(0,a.__)("CVV","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("div",{id:"ap-nmi-card-cvv"}))),"yes"===r.testmode&&(0,e.createElement)("div",{className:"ap-nmi-test-notice",style:{marginTop:"1em",padding:"0.5em",backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px"}},(0,a.__)("TEST MODE: Use a test card number.","gaincommerce-nmi-payment-gateway-for-woocommerce")),r.save_payment_enabled&&(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide",style:{marginTop:"1em"}},console.log("AP NMI Blocks: Rendering save payment checkbox, current state:",p),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Save payment method for future purchases","gaincommerce-nmi-payment-gateway-for-woocommerce"),checked:p,onChange:e=>{console.log("AP NMI Blocks: Checkbox onChange fired, new value:",e),y(e)},__nextHasNoMarginBottom:!0,className:"ap-nmi-save-payment-checkbox"})),!r.save_payment_enabled&&console.log("AP NMI Blocks: save_payment_enabled is FALSE, checkbox not rendered")))},s={name:r.wc_gateway_id||"gaincommerce_nmi",label:(0,e.createElement)(()=>(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)("span",null,r.title||c),r.description&&(0,e.createElement)("span",{style:{display:"block",fontSize:"0.9em",color:"#666",marginTop:"4px"}},r.description)),null),content:(0,e.createElement)(l,null),edit:(0,e.createElement)(l,null),canMakePayment:()=>"yes"===r.is_available,ariaLabel:r.title||c,supports:{features:r.supports||["products"]}};console.log("AP NMI Blocks: Registering payment method..."),(0,t.registerPaymentMethod)(s),console.log("AP NMI Blocks: Payment method registered successfully")})();