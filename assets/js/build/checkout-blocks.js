(()=>{"use strict";const e=window.wp.element,o=window.wp.i18n,a=wc.wcBlocksRegistry,t=wc.wcSettings,r=window.wp.components;console.log("AP NMI Blocks: Script loading...");const n=(0,t.getSetting)("gaincommerce_nmi_data",{}),c=(0,o.__)("Gain Commerce NMI Payment Gateway for WooCommerce","gaincommerce-nmi-payment-gateway-for-woocommerce");console.log("AP NMI Blocks: Settings loaded",n);const l=({billing:a,eventRegistration:t,emitResponse:c})=>{const{onPaymentSetup:l}=t,[m,s]=(0,e.useState)({ccnumber:!1,ccexp:!1,cvv:!0}),[i,d]=(0,e.useState)(null),[p,y]=(0,e.useState)(!1),u=(0,e.useRef)(!1),g=(0,e.useRef)(null);return(0,e.useEffect)(()=>{u.current=p},[p]),(0,e.useEffect)(()=>{if("undefined"==typeof CollectJS)return console.error("AP NMI Blocks: CollectJS not loaded"),void d((0,o.__)("Payment form failed to load. Please refresh the page.","gaincommerce-nmi-payment-gateway-for-woocommerce"));console.log("AP NMI Blocks: Initializing CollectJS..."),CollectJS.configure({variant:"inline",invalidCss:{color:"#e74c3c","border-color":"#e74c3c"},validCss:{color:"black","border-color":"#2ecc71"},placeholderCss:{color:"darkgray","background-color":"#ffffff"},focusCss:{color:"black","border-color":"#4681f4"},fields:{ccnumber:{selector:"#ap-nmi-card-number",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ap-nmi-expiry-date",title:"Card Expiration",placeholder:"MM/YY"},cvv:{display:"show",selector:"#ap-nmi-card-cvv",title:"CVV",placeholder:"123"}},validationCallback:(e,o,a)=>{console.log("AP NMI Blocks: Validation:",e,o,a),s(a=>({...a,[e.field||e]:o}))},callback:e=>{if(console.log("AP NMI Blocks: CollectJS callback triggered.",e),g.current){if(g.current.clearTimeout&&g.current.clearTimeout(),e.card&&e.card.type&&n.restricted_card_types.includes(e.card.type)){const e=(0,o.__)("This card type is not accepted.","gaincommerce-nmi-payment-gateway-for-woocommerce");return d(e),g.current.reject({type:c.responseTypes.ERROR,message:e}),void(g.current=null)}if(e.token)console.log("AP NMI Blocks: Token generated successfully:",e.token),console.log("AP NMI Blocks: savePaymentMethod state:",u.current),console.log("AP NMI Blocks: save_payment_method value being sent:",u.current?"1":"0"),g.current.resolve({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e.token,save_payment_method:u.current?"1":"0"}}}),console.log("AP NMI Blocks: paymentMethodData sent:",{payment_token:e.token,save_payment_method:u.current?"1":"0"});else{console.error("AP NMI Blocks: Token generation failed.",e);const a=e.error?.message||(0,o.__)("Invalid card details. Please check and try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");d(a),g.current.reject({type:c.responseTypes.ERROR,message:a})}g.current=null}}})},[]),(0,e.useEffect)(()=>l(()=>{if(console.log("AP NMI Blocks: onPaymentSetup triggered."),d(null),!Object.values(m).every(Boolean)){console.log("AP NMI Blocks: Validation failed before tokenization.",m);const e=(0,o.__)("Please fill in all required payment fields.","gaincommerce-nmi-payment-gateway-for-woocommerce");return d(e),{type:c.responseTypes.ERROR,message:e}}return console.log("AP NMI Blocks: All fields appear valid, requesting token..."),new Promise((e,a)=>{g.current={resolve:e,reject:a,clearTimeout:null};const t=setTimeout(()=>{console.error("AP NMI Blocks: Tokenization timed out.");const e=(0,o.__)("Payment processing timed out. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");d(e),g.current&&(g.current.reject({type:c.responseTypes.ERROR,message:e}),g.current=null)},15e3);g.current.clearTimeout=()=>clearTimeout(t),CollectJS.startPaymentRequest()})}),[l,m]),(0,e.createElement)("div",{className:"ap-nmi-payment-form-blocks"},i&&(0,e.createElement)("div",{className:"woocommerce-error",role:"alert"},i),(0,e.createElement)("div",{className:"ap-nni-card-icons-container"},(0,e.createElement)("div",{className:"ap-nmi-card-icons"},n.allowed_card_types&&Object.entries(n.allowed_card_types).map(([o,a])=>(0,e.createElement)("span",{key:o,className:`card-icon ${o} ${a.status}`,title:a.title}))),n.restricted_card_types.length>0&&(0,e.createElement)("div",{className:"ap-nmi-card-restrictions-info"},(0,o.__)("Cards marked with âœ• are not accepted for payment.","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("p",null)),(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-number"},(0,o.__)("Card Number","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-card-number"})),(0,e.createElement)("div",{className:"ap-nmi-row"},(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-first"},(0,e.createElement)("label",{htmlFor:"ap-nmi-expiry-date"},(0,o.__)("Expiry Date","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-expiry-date"})),(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-last"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-cvv"},(0,o.__)("CVV","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("div",{id:"ap-nmi-card-cvv"}))),"yes"===n.testmode&&(0,e.createElement)("div",{className:"ap-nmi-test-notice",style:{marginTop:"1em",padding:"0.5em",backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px"}},(0,o.__)("TEST MODE: Use a test card number.","gaincommerce-nmi-payment-gateway-for-woocommerce")),n.save_payment_enabled&&(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide",style:{marginTop:"1em"}},console.log("AP NMI Blocks: Rendering save payment checkbox, current state:",p),(0,e.createElement)(r.CheckboxControl,{label:(0,o.__)("Save payment method for future purchases","gaincommerce-nmi-payment-gateway-for-woocommerce"),checked:p,onChange:e=>{console.log("AP NMI Blocks: Checkbox onChange fired, new value:",e),y(e)},__nextHasNoMarginBottom:!0,className:"ap-nmi-save-payment-checkbox"})),!n.save_payment_enabled&&console.log("AP NMI Blocks: save_payment_enabled is FALSE, checkbox not rendered"))},m={name:n.wc_gateway_id||"gaincommerce_nmi",label:(0,e.createElement)(()=>(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)("span",null,n.title||c),n.description&&(0,e.createElement)("span",{style:{display:"block",fontSize:"0.9em",color:"#666",marginTop:"4px"}},n.description)),null),content:(0,e.createElement)(l,null),edit:(0,e.createElement)(l,null),canMakePayment:()=>"yes"===n.is_available,ariaLabel:n.title||c,supports:{features:n.supports||["products"]}};console.log("AP NMI Blocks: Registering payment method..."),(0,a.registerPaymentMethod)(m),console.log("AP NMI Blocks: Payment method registered successfully")})();