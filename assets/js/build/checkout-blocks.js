(()=>{"use strict";const e=window.wp.element,a=window.wp.i18n,t=wc.wcBlocksRegistry,r=wc.wcSettings;console.log("AP NMI Blocks: Script loading...");const o=(0,r.getSetting)("ap_nmi_data",{}),c=(0,a.__)("AP NMI Payment Gateway","gaincommerce-nmi-payment-gateway-for-woocommerce");console.log("AP NMI Blocks: Settings loaded",o);const n=({billing:t,eventRegistration:r,emitResponse:c})=>{const{onPaymentSetup:n}=r,[l,s]=(0,e.useState)({ccnumber:!1,ccexp:!1,cvv:!0}),[i,m]=(0,e.useState)(null),d=(0,e.useRef)(null);return(0,e.useEffect)(()=>{if("undefined"==typeof CollectJS)return console.error("AP NMI Blocks: CollectJS not loaded"),void m((0,a.__)("Payment form failed to load. Please refresh the page.","gaincommerce-nmi-payment-gateway-for-woocommerce"));console.log("AP NMI Blocks: Initializing CollectJS..."),CollectJS.configure({variant:"inline",invalidCss:{color:"#e74c3c","border-color":"#e74c3c"},validCss:{color:"black","border-color":"#2ecc71"},placeholderCss:{color:"darkgray","background-color":"#ffffff"},focusCss:{color:"black","border-color":"#4681f4"},fields:{ccnumber:{selector:"#ap-nmi-card-number",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ap-nmi-expiry-date",title:"Card Expiration",placeholder:"MM/YY"},cvv:{display:"show",selector:"#ap-nmi-card-cvv",title:"CVV",placeholder:"123"}},validationCallback:(e,a,t)=>{console.log("AP NMI Blocks: Validation:",e,a,t),s(t=>({...t,[e.field||e]:a}))},callback:e=>{if(console.log("AP NMI Blocks: CollectJS callback triggered.",e),d.current){if(d.current.clearTimeout&&d.current.clearTimeout(),e.card&&e.card.type&&o.restricted_card_types.includes(e.card.type)){const e=(0,a.__)("This card type is not accepted.","gaincommerce-nmi-payment-gateway-for-woocommerce");return m(e),d.current.reject({type:c.responseTypes.ERROR,message:e}),void(d.current=null)}if(e.token)console.log("AP NMI Blocks: Token generated successfully:",e.token),d.current.resolve({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e.token}}});else{console.error("AP NMI Blocks: Token generation failed.",e);const t=e.error?.message||(0,a.__)("Invalid card details. Please check and try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");m(t),d.current.reject({type:c.responseTypes.ERROR,message:t})}d.current=null}}})},[]),(0,e.useEffect)(()=>n(()=>{if(console.log("AP NMI Blocks: onPaymentSetup triggered."),m(null),!Object.values(l).every(Boolean)){console.log("AP NMI Blocks: Validation failed before tokenization.",l);const e=(0,a.__)("Please fill in all required payment fields.","gaincommerce-nmi-payment-gateway-for-woocommerce");return m(e),{type:c.responseTypes.ERROR,message:e}}return console.log("AP NMI Blocks: All fields appear valid, requesting token..."),new Promise((e,t)=>{d.current={resolve:e,reject:t,clearTimeout:null};const r=setTimeout(()=>{console.error("AP NMI Blocks: Tokenization timed out.");const e=(0,a.__)("Payment processing timed out. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");m(e),d.current&&(d.current.reject({type:c.responseTypes.ERROR,message:e}),d.current=null)},15e3);d.current.clearTimeout=()=>clearTimeout(r),CollectJS.startPaymentRequest()})}),[n,l]),(0,e.createElement)("div",{className:"ap-nmi-payment-form-blocks"},i&&(0,e.createElement)("div",{className:"woocommerce-error",role:"alert"},i),(0,e.createElement)("div",{className:"ap-nni-card-icons-container"},(0,e.createElement)("div",{className:"ap-nmi-card-icons"},o.allowed_card_types&&Object.entries(o.allowed_card_types).map(([a,t])=>(0,e.createElement)("span",{key:a,className:`card-icon ${a} ${t.status}`,title:t.title}))),o.restricted_card_types.length>0&&(0,e.createElement)("div",{className:"ap-nmi-card-restrictions-info"},(0,a.__)("Cards marked with âœ• are not accepted for payment.","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("p",null)),(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-number"},(0,a.__)("Card Number","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-card-number"})),(0,e.createElement)("div",{className:"ap-nmi-row"},(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-first"},(0,e.createElement)("label",{htmlFor:"ap-nmi-expiry-date"},(0,a.__)("Expiry Date","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-expiry-date"})),(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-last"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-cvv"},(0,a.__)("CVV","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("div",{id:"ap-nmi-card-cvv"}))),"yes"===o.testmode&&(0,e.createElement)("div",{className:"ap-nmi-test-notice",style:{marginTop:"1em",padding:"0.5em",backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px"}},(0,a.__)("TEST MODE: Use a test card number.","gaincommerce-nmi-payment-gateway-for-woocommerce")))},l={name:o.wc_gateway_id,label:(0,e.createElement)(()=>(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)("span",null,o.title||c),o.description&&(0,e.createElement)("span",{style:{display:"block",fontSize:"0.9em",color:"#666",marginTop:"4px"}},o.description)),null),content:(0,e.createElement)(n,null),edit:(0,e.createElement)(n,null),canMakePayment:()=>"yes"===o.is_available,ariaLabel:o.title||c,supports:{features:o.supports||["products"]}};console.log("AP NMI Blocks: Registering payment method..."),(0,t.registerPaymentMethod)(l),console.log("AP NMI Blocks: Payment method registered successfully")})();