(()=>{"use strict";const e=window.wp.element,n=window.wp.i18n,t=wc.wcBlocksRegistry,o=wc.wcSettings,a=window.wp.components;console.log("AP NMI Blocks: Script loading...");const r=(0,o.getSetting)("gaincommerce_nmi_data",{}),c=(0,n.__)("Gain Commerce NMI Payment Gateway for WooCommerce","gaincommerce-nmi-payment-gateway-for-woocommerce");console.log("AP NMI Blocks: Settings loaded",r);const s=({billing:t,eventRegistration:o,emitResponse:c})=>{const{onPaymentSetup:s}=o,[i,m]=(0,e.useState)({ccnumber:!1,ccexp:!1,cvv:!0}),[d,p]=(0,e.useState)(null),[y,u]=(0,e.useState)(!1),[g,_]=(0,e.useState)(!1),f=(0,e.useRef)(!1),w=(0,e.useRef)(!1),h=(0,e.useRef)(null);return(0,e.useEffect)(()=>{f.current=y},[y]),(0,e.useEffect)(()=>{w.current=g},[g]),(0,e.useEffect)(()=>{if("undefined"==typeof CollectJS)return console.error("AP NMI Blocks: CollectJS not loaded"),void p((0,n.__)("Payment form failed to load. Please refresh the page.","gaincommerce-nmi-payment-gateway-for-woocommerce"));console.log("AP NMI Blocks: Initializing CollectJS..."),CollectJS.configure({variant:"inline",invalidCss:{color:"#e74c3c","border-color":"#e74c3c"},validCss:{color:"black","border-color":"#2ecc71"},placeholderCss:{color:"darkgray","background-color":"#ffffff"},focusCss:{color:"black","border-color":"#4681f4"},fields:{ccnumber:{selector:"#ap-nmi-card-number",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ap-nmi-expiry-date",title:"Card Expiration",placeholder:"MM/YY"},cvv:{display:"show",selector:"#ap-nmi-card-cvv",title:"CVV",placeholder:"123"}},validationCallback:(e,n,t)=>{console.log("AP NMI Blocks: Validation:",e,n,t),m(t=>({...t,[e.field||e]:n}))},callback:e=>{if(console.log("AP NMI Blocks: CollectJS callback triggered.",e),h.current){if(h.current.clearTimeout&&h.current.clearTimeout(),e.card&&e.card.type&&r.restricted_card_types.includes(e.card.type)){const e=(0,n.__)("This card type is not accepted.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),h.current.reject({type:c.responseTypes.ERROR,message:e}),void(h.current=null)}if(e.token)console.log("AP NMI Blocks: Token generated successfully:",e.token),"undefined"!=typeof ap_nmi_threeds_config&&"yes"===ap_nmi_threeds_config.enable_3ds&&"undefined"!=typeof Gateway?(console.log("AP NMI Blocks: 3DS enabled, initiating authentication..."),nmiBlocksHandle3DSForNewCard(e.token,h.current.resolve,h.current.reject,p),h.current=null):(console.log("AP NMI Blocks: savePaymentMethod state:",f.current),console.log("AP NMI Blocks: save_payment_method value being sent:",f.current?"1":"0"),h.current.resolve({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e.token,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}}}),console.log("AP NMI Blocks: paymentMethodData sent:",{payment_token:e.token,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}),h.current=null);else{console.error("AP NMI Blocks: Token generation failed.",e);const t=e.error?.message||(0,n.__)("Invalid card details. Please check and try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");p(t),h.current.reject({type:c.responseTypes.ERROR,message:t}),h.current=null}h.current=null}}})},[]),(0,e.useEffect)(()=>{const e=s(()=>{console.log("AP NMI Blocks: onPaymentSetup triggered."),p(null);const e="undefined"!=typeof ap_nmi_threeds_config&&"yes"===ap_nmi_threeds_config.enable_3ds;if(w.current&&r.has_saved_card)return console.log("AP NMI Blocks: Using saved payment method."),e&&"undefined"!=typeof Gateway?(console.log("AP NMI Blocks: 3DS enabled for saved card, authenticating..."),new Promise((e,t)=>{const o=r.customer_vault_id;if(!o){const e=(0,n.__)("Customer vault ID not found.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),void t({type:c.responseTypes.ERROR,message:e})}nmiBlocksHandle3DSForVault(o,e,t,p)})):{type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0"}}};if(!Object.values(i).every(Boolean)){console.log("AP NMI Blocks: Validation failed before tokenization.",i);const e=(0,n.__)("Please fill in all required payment fields.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),{type:c.responseTypes.ERROR,message:e}}return console.log("AP NMI Blocks: All fields appear valid, requesting token..."),new Promise((e,t)=>{h.current={resolve:e,reject:t,clearTimeout:null};const o=setTimeout(()=>{console.error("AP NMI Blocks: Tokenization timed out.");const e=(0,n.__)("Payment processing timed out. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");p(e),h.current&&(h.current.reject({type:c.responseTypes.ERROR,message:e}),h.current=null)},15e3);h.current.clearTimeout=()=>clearTimeout(o),CollectJS.startPaymentRequest()})});return window.currentNmi3DSInstance=null,window.nmiBlocksSafe3DSData=function(e){const n={};return"string"==typeof e.cavv&&e.cavv&&(n.cavv=e.cavv),"string"==typeof e.xid&&e.xid&&(n.xid=e.xid),"string"==typeof e.eci&&e.eci&&(n.eci=e.eci),"string"==typeof e.cardHolderAuth&&e.cardHolderAuth&&(n.cardholder_auth=e.cardHolderAuth),"string"==typeof e.threeDsVersion&&e.threeDsVersion&&(n.three_ds_version=e.threeDsVersion),"string"==typeof e.directoryServerId&&e.directoryServerId&&(n.directory_server_id=e.directoryServerId),"string"==typeof e.cardHolderInfo&&e.cardHolderInfo&&(n.cardholder_info=e.cardHolderInfo),console.log("AP NMI Blocks: Safe 3DS data prepared",{has_cavv:!!n.cavv,has_xid:!!n.xid,three_ds_version:n.three_ds_version||"none"}),n},window.nmiBlocksHandle3DSForVault=function(e,t,o,a){try{if(window.currentNmi3DSInstance){console.log("AP NMI Blocks: Unmounting existing 3DS instance");try{window.currentNmi3DSInstance.unmount()}catch(e){console.warn("AP NMI Blocks: Error unmounting 3DS instance:",e)}window.currentNmi3DSInstance=null}const r=ap_nmi_threeds_config.public_key;console.log("AP NMI Blocks: 3DS Key for Saved Card",{gatewayjs_key:r?r.substring(0,20)+"...":"EMPTY",vault_id:e});const s=Gateway.create(ap_nmi_threeds_config.public_key),i=s.get3DSecure(),m={customerVaultId:e,currency:ap_nmi_threeds_config.currency,amount:ap_nmi_threeds_config.amount};Object.assign(m,l()),console.log("AP NMI Blocks: 3DS options for vault:",m);const d=i.createUI(m);window.currentNmi3DSInstance=d,d.start("#threeDSMountPoint"),d.on("challenge",function(e){console.log("AP NMI Blocks: 3DS Challenge for saved card")}),d.on("complete",function(e){console.log("AP NMI Blocks: 3DS complete for saved card:",e);const n=window.nmiBlocksSafe3DSData(e);t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0",...n}}})}),d.on("failure",function(e){console.error("AP NMI Blocks: 3DS failed for saved card:",e);const a=ap_nmi_threeds_config["3ds_failure_action"]||"decline";"decline"===a?o({type:c.responseTypes.ERROR,message:(0,n.__)("Card verification failed. Please try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")}):"continue_without_3ds"===a?t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0"}}}):"continue_with_warning"===a&&t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0",threeds_warning:"authentication_failed"}}})}),s.on("error",function(e){console.error("AP NMI Blocks: Gateway error for saved card:",e);let t=(0,n.__)("Payment verification error. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");e.message&&e.message.includes("3DSecure is inactive")&&(console.error("NMI 3DS Error: 3-D Secure is not enabled on your NMI merchant account"),t=(0,n.__)("Secure payment verification is currently unavailable. Please contact the store or try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")),console.log("AP NMI Blocks: Calling setError for saved card with message:",t);const r=document.querySelector(".wc-block-components-notices");r&&(r.innerHTML=`<div class="wc-block-components-notice-banner is-error" role="alert"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false"><path d="M12 3.2c-4.8 0-8.8 3.9-8.8 8.8 0 4.8 3.9 8.8 8.8 8.8 4.8 0 8.8-3.9 8.8-8.8 0-4.8-4-8.8-8.8-8.8zm0 16c-4 0-7.2-3.3-7.2-7.2C4.8 8 8 4.8 12 4.8s7.2 3.3 7.2 7.2c0 4-3.2 7.2-7.2 7.2zM11 17h2v-6h-2v6zm0-8h2V7h-2v2z"></path></svg><div class="wc-block-components-notice-banner__content">${t}</div></div>`),alert(t),a(t),o({type:c.responseTypes.ERROR,message:t})})}catch(e){console.error("AP NMI Blocks: 3DS initialization error for saved card:",e);const t=(0,n.__)("Unable to initialize card verification. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");alert(t),o({type:c.responseTypes.ERROR,message:t})}},window.nmiBlocksHandle3DSForNewCard=function(e,t,o,a){try{if(window.currentNmi3DSInstance){console.log("AP NMI Blocks: Unmounting existing 3DS instance");try{window.currentNmi3DSInstance.unmount()}catch(e){console.warn("AP NMI Blocks: Error unmounting 3DS instance:",e)}window.currentNmi3DSInstance=null}const r="undefined"!=typeof ap_nmi_params?ap_nmi_params.public_key:"NOT FOUND",s=ap_nmi_threeds_config.public_key,i=r===s;console.log("AP NMI Blocks: 3DS Key Verification for New Card",{collectjs_key:r?r.substring(0,20)+"...":"EMPTY",gatewayjs_key:s?s.substring(0,20)+"...":"EMPTY",keys_match:i?"YES":"NO - MISMATCH DETECTED!",token:e.substring(0,20)+"..."}),i||console.error('AP NMI Blocks: KEY MISMATCH! CollectJS token generated with one key, but Gateway.js using different key. This causes "Payment Token does not exist" errors.');const m=Gateway.create(ap_nmi_threeds_config.public_key),d=m.get3DSecure(),p={paymentToken:e,currency:ap_nmi_threeds_config.currency,amount:ap_nmi_threeds_config.amount};ap_nmi_threeds_config.billing_data&&Object.assign(p,ap_nmi_threeds_config.billing_data),Object.assign(p,l()),console.log("AP NMI Blocks: 3DS options for new card:",p);const y=d.createUI(p);window.currentNmi3DSInstance=y,y.start("#threeDSMountPoint"),y.on("challenge",function(e){console.log("AP NMI Blocks: 3DS Challenge for new card")}),y.on("complete",function(n){console.log("AP NMI Blocks: 3DS complete for new card:",n);const o=window.nmiBlocksSafe3DSData(n);t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0",...o}}})}),y.on("failure",function(a){console.error("AP NMI Blocks: 3DS failed for new card:",a);const r=ap_nmi_threeds_config["3ds_failure_action"]||"decline";"decline"===r?o({type:c.responseTypes.ERROR,message:(0,n.__)("Card verification failed. Please try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")}):"continue_without_3ds"===r?t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}}}):"continue_with_warning"===r&&t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0",threeds_warning:"authentication_failed"}}})}),m.on("error",function(e){console.error("AP NMI Blocks: Gateway error for new card:",e);let t=(0,n.__)("Payment verification error. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");e.message&&e.message.includes("3DSecure is inactive")&&(console.error("NMI 3DS Error: 3-D Secure is not enabled on your NMI merchant account"),t=(0,n.__)("Secure payment verification is currently unavailable. Please contact the store or try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")),console.log("AP NMI Blocks: Calling setError for new card with message:",t);const r=document.querySelector(".wc-block-components-notices");r&&(r.innerHTML=`<div class="wc-block-components-notice-banner is-error" role="alert"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false"><path d="M12 3.2c-4.8 0-8.8 3.9-8.8 8.8 0 4.8 3.9 8.8 8.8 8.8 4.8 0 8.8-3.9 8.8-8.8 0-4.8-4-8.8-8.8-8.8zm0 16c-4 0-7.2-3.3-7.2-7.2C4.8 8 8 4.8 12 4.8s7.2 3.3 7.2 7.2c0 4-3.2 7.2-7.2 7.2zM11 17h2v-6h-2v6zm0-8h2V7h-2v2z"></path></svg><div class="wc-block-components-notice-banner__content">${t}</div></div>`),alert(t),a(t),o({type:c.responseTypes.ERROR,message:t})})}catch(e){console.error("AP NMI Blocks: 3DS initialization error for new card:",e);const t=(0,n.__)("Unable to initialize card verification. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");alert(t),o({type:c.responseTypes.ERROR,message:t})}},e},[s,i,g]),(0,e.createElement)("div",{className:"ap-nmi-payment-form-blocks"},d&&(0,e.createElement)("div",{className:"woocommerce-error",role:"alert",style:{backgroundColor:"#e2401c",color:"#fff",padding:"1em",marginBottom:"1em",borderRadius:"4px",fontSize:"14px",lineHeight:"1.5"}},d),r.has_saved_card&&r.saved_card_details&&(0,e.createElement)("div",{className:"ap-nmi-saved-card-selection",style:{marginBottom:"1em"}},(0,e.createElement)("label",{style:{display:"block",marginBottom:"0.5em"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"1",checked:g,onChange:()=>_(!0),style:{marginRight:"0.5em"}}),(0,n.__)("Use saved card ending in","gaincommerce-nmi-payment-gateway-for-woocommerce")," ****",r.saved_card_details.last4,r.saved_card_details.type&&` (${r.saved_card_details.type})`,r.saved_card_details.exp_date&&` - Exp: ${r.saved_card_details.exp_date}`),(0,e.createElement)("label",{style:{display:"block"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"0",checked:!g,onChange:()=>_(!1),style:{marginRight:"0.5em"}}),(0,n.__)("Use a new card","gaincommerce-nmi-payment-gateway-for-woocommerce"))),(0,e.createElement)("div",{style:{display:r.has_saved_card&&g?"none":"block"}},(0,e.createElement)("div",{className:"ap-nni-card-icons-container"},(0,e.createElement)("div",{className:"ap-nmi-card-icons"},r.allowed_card_types&&Object.entries(r.allowed_card_types).map(([n,t])=>(0,e.createElement)("span",{key:n,className:`card-icon ${n} ${t.status}`,title:t.title}))),r.restricted_card_types.length>0&&(0,e.createElement)("div",{className:"ap-nmi-card-restrictions-info"},(0,n.__)("Cards marked with âœ• are not accepted for payment.","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("p",null)),(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-number"},(0,n.__)("Card Number","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-card-number"})),(0,e.createElement)("div",{className:"ap-nmi-row"},(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-first"},(0,e.createElement)("label",{htmlFor:"ap-nmi-expiry-date"},(0,n.__)("Expiry Date","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-expiry-date"})),(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-last"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-cvv"},(0,n.__)("CVV","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("div",{id:"ap-nmi-card-cvv"}))),"yes"===r.testmode&&(0,e.createElement)("div",{className:"ap-nmi-test-notice",style:{marginTop:"1em",padding:"0.5em",backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px"}},(0,n.__)("TEST MODE: Use a test card number.","gaincommerce-nmi-payment-gateway-for-woocommerce")),r.save_payment_enabled&&(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide",style:{marginTop:"1em"}},console.log("AP NMI Blocks: Rendering save payment checkbox, current state:",y),(0,e.createElement)(a.CheckboxControl,{label:(0,n.__)("Save payment method for future purchases","gaincommerce-nmi-payment-gateway-for-woocommerce"),checked:y,onChange:e=>{console.log("AP NMI Blocks: Checkbox onChange fired, new value:",e),u(e)},__nextHasNoMarginBottom:!0,className:"ap-nmi-save-payment-checkbox"})),!r.save_payment_enabled&&console.log("AP NMI Blocks: save_payment_enabled is FALSE, checkbox not rendered"),(0,e.createElement)("div",{id:"threeDSMountPoint",style:{marginTop:"15px",minHeight:"400px",maxWidth:"100%",position:"relative"}}),(0,e.createElement)("div",{id:"threeDSMessage",style:{display:"none",padding:"10px",background:"#f0f0f0",marginTop:"10px",borderRadius:"4px",textAlign:"center"}})))},i={name:r.wc_gateway_id||"gaincommerce_nmi",label:(0,e.createElement)(()=>(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)("span",null,r.title||c),r.description&&(0,e.createElement)("span",{style:{display:"block",fontSize:"0.9em",color:"#666",marginTop:"4px"}},r.description)),null),content:(0,e.createElement)(s,null),edit:(0,e.createElement)(s,null),canMakePayment:()=>"yes"===r.is_available,ariaLabel:r.title||c,supports:{features:r.supports||["products"]}};function l(){let e="false";try{navigator.javaEnabled&&"function"==typeof navigator.javaEnabled&&(e=navigator.javaEnabled()?"true":"false")}catch(n){e="false"}return{browserJavaEnabled:e,browserJavascriptEnabled:"true",browserLanguage:window.navigator.language||window.navigator.userLanguage||"en-US",browserColorDepth:String(window.screen.colorDepth||"24"),browserScreenHeight:String(window.screen.height||"768"),browserScreenWidth:String(window.screen.width||"1024"),browserTimeZone:String((new Date).getTimezoneOffset()),deviceChannel:"Browser"}}console.log("AP NMI Blocks: Registering payment method..."),(0,t.registerPaymentMethod)(i),console.log("AP NMI Blocks: Payment method registered successfully")})();