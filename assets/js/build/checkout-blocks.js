(()=>{"use strict";const e=window.wp.element,a=window.wp.i18n,t=wc.wcBlocksRegistry,o=wc.wcSettings,n=window.wp.components;console.log("AP NMI Blocks: Script loading...");const r=(0,o.getSetting)("gaincommerce_nmi_data",{}),c=(0,a.__)("Gain Commerce NMI Payment Gateway for WooCommerce","gaincommerce-nmi-payment-gateway-for-woocommerce");console.log("AP NMI Blocks: Settings loaded",r);const s=({billing:t,eventRegistration:o,emitResponse:c})=>{const{onPaymentSetup:s}=o,[i,m]=(0,e.useState)({ccnumber:!1,ccexp:!1,cvv:!0}),[d,p]=(0,e.useState)(null),[_,y]=(0,e.useState)(!1),[u,g]=(0,e.useState)(!1),f=(0,e.useRef)(!1),h=(0,e.useRef)(!1),v=(0,e.useRef)(null);return(0,e.useEffect)(()=>{f.current=_},[_]),(0,e.useEffect)(()=>{h.current=u},[u]),(0,e.useEffect)(()=>{if("undefined"==typeof CollectJS)return console.error("AP NMI Blocks: CollectJS not loaded"),void p((0,a.__)("Payment form failed to load. Please refresh the page.","gaincommerce-nmi-payment-gateway-for-woocommerce"));console.log("AP NMI Blocks: Initializing CollectJS..."),CollectJS.configure({variant:"inline",invalidCss:{color:"#e74c3c","border-color":"#e74c3c"},validCss:{color:"black","border-color":"#2ecc71"},placeholderCss:{color:"darkgray","background-color":"#ffffff"},focusCss:{color:"black","border-color":"#4681f4"},fields:{ccnumber:{selector:"#ap-nmi-card-number",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ap-nmi-expiry-date",title:"Card Expiration",placeholder:"MM/YY"},cvv:{display:"show",selector:"#ap-nmi-card-cvv",title:"CVV",placeholder:"123"}},validationCallback:(e,a,t)=>{console.log("AP NMI Blocks: Validation:",e,a,t),m(t=>({...t,[e.field||e]:a}))},callback:e=>{if(console.log("AP NMI Blocks: CollectJS callback triggered.",e),v.current){if(v.current.clearTimeout&&v.current.clearTimeout(),e.card&&e.card.type&&r.restricted_card_types.includes(e.card.type)){const e=(0,a.__)("This card type is not accepted.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),v.current.reject({type:c.responseTypes.ERROR,message:e}),void(v.current=null)}if(e.token)console.log("AP NMI Blocks: Token generated successfully:",e.token),"undefined"!=typeof ap_nmi_threeds_config&&"yes"===ap_nmi_threeds_config.enable_3ds&&"undefined"!=typeof Gateway?(console.log("AP NMI Blocks: 3DS enabled, initiating authentication..."),nmiBlocksHandle3DSForNewCard(e.token,v.current.resolve,v.current.reject),v.current=null):(console.log("AP NMI Blocks: savePaymentMethod state:",f.current),console.log("AP NMI Blocks: save_payment_method value being sent:",f.current?"1":"0"),v.current.resolve({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e.token,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}}}),console.log("AP NMI Blocks: paymentMethodData sent:",{payment_token:e.token,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}),v.current=null);else{console.error("AP NMI Blocks: Token generation failed.",e);const t=e.error?.message||(0,a.__)("Invalid card details. Please check and try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");p(t),v.current.reject({type:c.responseTypes.ERROR,message:t}),v.current=null}v.current=null}}})},[]),(0,e.useEffect)(()=>{const e=s(()=>{console.log("AP NMI Blocks: onPaymentSetup triggered."),p(null);const e="undefined"!=typeof ap_nmi_threeds_config&&"yes"===ap_nmi_threeds_config.enable_3ds;if(h.current&&r.has_saved_card)return console.log("AP NMI Blocks: Using saved payment method."),e&&"undefined"!=typeof Gateway?(console.log("AP NMI Blocks: 3DS enabled for saved card, authenticating..."),new Promise((e,t)=>{const o=r.customer_vault_id;if(!o){const e=(0,a.__)("Customer vault ID not found.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),void t({type:c.responseTypes.ERROR,message:e})}nmiBlocksHandle3DSForVault(o,e,t)})):{type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0"}}};if(!Object.values(i).every(Boolean)){console.log("AP NMI Blocks: Validation failed before tokenization.",i);const e=(0,a.__)("Please fill in all required payment fields.","gaincommerce-nmi-payment-gateway-for-woocommerce");return p(e),{type:c.responseTypes.ERROR,message:e}}return console.log("AP NMI Blocks: All fields appear valid, requesting token..."),new Promise((e,t)=>{v.current={resolve:e,reject:t,clearTimeout:null};const o=setTimeout(()=>{console.error("AP NMI Blocks: Tokenization timed out.");const e=(0,a.__)("Payment processing timed out. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce");p(e),v.current&&(v.current.reject({type:c.responseTypes.ERROR,message:e}),v.current=null)},15e3);v.current.clearTimeout=()=>clearTimeout(o),CollectJS.startPaymentRequest()})});return window.nmiBlocksHandle3DSForVault=function(e,t,o){try{const n=Gateway.create(ap_nmi_threeds_config.public_key),r=n.get3DSecure(),s={customerVaultId:e,currency:ap_nmi_threeds_config.currency,amount:ap_nmi_threeds_config.amount};Object.assign(s,l()),console.log("AP NMI Blocks: 3DS options for vault:",s);const i=r.createUI(s);i.start("#threeDSMountPoint"),i.on("challenge",function(e){console.log("AP NMI Blocks: 3DS Challenge for saved card")}),i.on("complete",function(e){console.log("AP NMI Blocks: 3DS complete for saved card:",e),t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0",cavv:e.cavv,xid:e.xid,eci:e.eci,cardholder_auth:e.cardHolderAuth,three_ds_version:e.threeDsVersion,directory_server_id:e.directoryServerId,cardholder_info:e.cardHolderInfo}}})}),i.on("failure",function(e){console.error("AP NMI Blocks: 3DS failed for saved card:",e);const n=ap_nmi_threeds_config["3ds_failure_action"]||"decline";"decline"===n?o({type:c.responseTypes.ERROR,message:(0,a.__)("Card verification failed. Please try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")}):"continue_without_3ds"===n?t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0"}}}):"continue_with_warning"===n&&t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{use_save_payment_method:"1",save_payment_method:"0",threeds_warning:"authentication_failed"}}})}),n.on("error",function(e){console.error("AP NMI Blocks: Gateway error for saved card:",e),o({type:c.responseTypes.ERROR,message:(0,a.__)("Payment verification error. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce")})})}catch(e){console.error("AP NMI Blocks: 3DS initialization error for saved card:",e),o({type:c.responseTypes.ERROR,message:(0,a.__)("Unable to initialize card verification. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce")})}},window.nmiBlocksHandle3DSForNewCard=function(e,t,o){try{const n=Gateway.create(ap_nmi_threeds_config.public_key),r=n.get3DSecure(),s={paymentToken:e,currency:ap_nmi_threeds_config.currency,amount:ap_nmi_threeds_config.amount};ap_nmi_threeds_config.billing_data&&Object.assign(s,ap_nmi_threeds_config.billing_data),Object.assign(s,l()),console.log("AP NMI Blocks: 3DS options for new card:",s);const i=r.createUI(s);i.start("#threeDSMountPoint"),i.on("challenge",function(e){console.log("AP NMI Blocks: 3DS Challenge for new card")}),i.on("complete",function(a){console.log("AP NMI Blocks: 3DS complete for new card:",a),t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0",cavv:a.cavv,xid:a.xid,eci:a.eci,cardholder_auth:a.cardHolderAuth,three_ds_version:a.threeDsVersion,directory_server_id:a.directoryServerId,cardholder_info:a.cardHolderInfo}}})}),i.on("failure",function(n){console.error("AP NMI Blocks: 3DS failed for new card:",n);const r=ap_nmi_threeds_config["3ds_failure_action"]||"decline";"decline"===r?o({type:c.responseTypes.ERROR,message:(0,a.__)("Card verification failed. Please try a different payment method.","gaincommerce-nmi-payment-gateway-for-woocommerce")}):"continue_without_3ds"===r?t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0"}}}):"continue_with_warning"===r&&t({type:c.responseTypes.SUCCESS,meta:{paymentMethodData:{payment_token:e,save_payment_method:f.current?"1":"0",use_save_payment_method:"0",threeds_warning:"authentication_failed"}}})}),n.on("error",function(e){console.error("AP NMI Blocks: Gateway error for new card:",e),o({type:c.responseTypes.ERROR,message:(0,a.__)("Payment verification error. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce")})})}catch(e){console.error("AP NMI Blocks: 3DS initialization error for new card:",e),o({type:c.responseTypes.ERROR,message:(0,a.__)("Unable to initialize card verification. Please try again.","gaincommerce-nmi-payment-gateway-for-woocommerce")})}},e},[s,i,u]),(0,e.createElement)("div",{className:"ap-nmi-payment-form-blocks"},d&&(0,e.createElement)("div",{className:"woocommerce-error",role:"alert"},d),r.has_saved_card&&r.saved_card_details&&(0,e.createElement)("div",{className:"ap-nmi-saved-card-selection",style:{marginBottom:"1em"}},(0,e.createElement)("label",{style:{display:"block",marginBottom:"0.5em"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"1",checked:u,onChange:()=>g(!0),style:{marginRight:"0.5em"}}),(0,a.__)("Use saved card ending in","gaincommerce-nmi-payment-gateway-for-woocommerce")," ****",r.saved_card_details.last4,r.saved_card_details.type&&` (${r.saved_card_details.type})`,r.saved_card_details.exp_date&&` - Exp: ${r.saved_card_details.exp_date}`),(0,e.createElement)("label",{style:{display:"block"}},(0,e.createElement)("input",{type:"radio",name:"use_save_payment_method",value:"0",checked:!u,onChange:()=>g(!1),style:{marginRight:"0.5em"}}),(0,a.__)("Use a new card","gaincommerce-nmi-payment-gateway-for-woocommerce"))),(0,e.createElement)("div",{style:{display:r.has_saved_card&&u?"none":"block"}},(0,e.createElement)("div",{className:"ap-nni-card-icons-container"},(0,e.createElement)("div",{className:"ap-nmi-card-icons"},r.allowed_card_types&&Object.entries(r.allowed_card_types).map(([a,t])=>(0,e.createElement)("span",{key:a,className:`card-icon ${a} ${t.status}`,title:t.title}))),r.restricted_card_types.length>0&&(0,e.createElement)("div",{className:"ap-nmi-card-restrictions-info"},(0,a.__)("Cards marked with âœ• are not accepted for payment.","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("p",null)),(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-number"},(0,a.__)("Card Number","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-card-number"})),(0,e.createElement)("div",{className:"ap-nmi-row"},(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-first"},(0,e.createElement)("label",{htmlFor:"ap-nmi-expiry-date"},(0,a.__)("Expiry Date","gaincommerce-nmi-payment-gateway-for-woocommerce")," ",(0,e.createElement)("span",{className:"required"},"*")),(0,e.createElement)("div",{id:"ap-nmi-expiry-date"})),(0,e.createElement)("div",{className:"ap-nmi-field ap-nmi-half form-row form-row-last"},(0,e.createElement)("label",{htmlFor:"ap-nmi-card-cvv"},(0,a.__)("CVV","gaincommerce-nmi-payment-gateway-for-woocommerce")),(0,e.createElement)("div",{id:"ap-nmi-card-cvv"}))),"yes"===r.testmode&&(0,e.createElement)("div",{className:"ap-nmi-test-notice",style:{marginTop:"1em",padding:"0.5em",backgroundColor:"#f0f0f0",border:"1px solid #ddd",borderRadius:"4px"}},(0,a.__)("TEST MODE: Use a test card number.","gaincommerce-nmi-payment-gateway-for-woocommerce")),r.save_payment_enabled&&(0,e.createElement)("div",{className:"ap-nmi-field form-row form-row-wide",style:{marginTop:"1em"}},console.log("AP NMI Blocks: Rendering save payment checkbox, current state:",_),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Save payment method for future purchases","gaincommerce-nmi-payment-gateway-for-woocommerce"),checked:_,onChange:e=>{console.log("AP NMI Blocks: Checkbox onChange fired, new value:",e),y(e)},__nextHasNoMarginBottom:!0,className:"ap-nmi-save-payment-checkbox"})),!r.save_payment_enabled&&console.log("AP NMI Blocks: save_payment_enabled is FALSE, checkbox not rendered"),(0,e.createElement)("div",{id:"threeDSMountPoint",style:{marginTop:"15px",minHeight:"400px",maxWidth:"100%",position:"relative"}}),(0,e.createElement)("div",{id:"threeDSMessage",style:{display:"none",padding:"10px",background:"#f0f0f0",marginTop:"10px",borderRadius:"4px",textAlign:"center"}})))},i={name:r.wc_gateway_id||"gaincommerce_nmi",label:(0,e.createElement)(()=>(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)("span",null,r.title||c),r.description&&(0,e.createElement)("span",{style:{display:"block",fontSize:"0.9em",color:"#666",marginTop:"4px"}},r.description)),null),content:(0,e.createElement)(s,null),edit:(0,e.createElement)(s,null),canMakePayment:()=>"yes"===r.is_available,ariaLabel:r.title||c,supports:{features:r.supports||["products"]}};function l(){let e="false";try{navigator.javaEnabled&&"function"==typeof navigator.javaEnabled&&(e=navigator.javaEnabled()?"true":"false")}catch(a){e="false"}return{browserJavaEnabled:e,browserJavascriptEnabled:"true",browserLanguage:window.navigator.language||window.navigator.userLanguage||"en-US",browserColorDepth:String(window.screen.colorDepth||"24"),browserScreenHeight:String(window.screen.height||"768"),browserScreenWidth:String(window.screen.width||"1024"),browserTimeZone:String((new Date).getTimezoneOffset()),deviceChannel:"Browser"}}console.log("AP NMI Blocks: Registering payment method..."),(0,t.registerPaymentMethod)(i),console.log("AP NMI Blocks: Payment method registered successfully")})();